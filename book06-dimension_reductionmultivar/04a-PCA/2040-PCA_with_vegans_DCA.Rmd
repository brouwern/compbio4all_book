# vegan PCA: Principal Components Analysis with vegans rda function

TODO: swap out irises

```{r   eval = T}
library(compbio4all)
library(ggplot2)
```



PCA (Principal Components Analysis) is easy in R, but the standard biplot() function is a little clunky.  The vegan package can do PCA using the rda() function (normally for redundancy analysis) and has some nice plotting functions.  (Note that ggplot is also developing biplot tools).


# Fisher's Irises

* 3 species
* 4 response variables

```{r}
data("iris")
summary(iris)
```

# Visualize variables in 2D

```{r}
pairs(iris,
      lower.panel = NULL, 
      col = as.numeric(iris$Species))
```

Note: can also be done in ggplot using GGalley::ggpairs; however, not updated for most recent version of R.


# Do PCA with base R function

## Run PCA

* NOTE: there is also a similar function to princomp(), prcomp()

```{r}
#"[,-5]" drops that last columns
##the species code
iris.pca <- princomp(iris[,-5])
```

## Plot Biplot in base graphics

```{r}
biplot(iris.pca)
```

There are is also ggplot biplot code somewhere outthere on the internet.

# Do PCA with vegan::rda

* rda = redundancy analysis
* normally RDA is used for "constrained ordination" (ordination w/covariates or predictor)
* without predictors, RDA is the same as PCA
* in vegan, givig the function rda() dataframe without predictors runs a PCA very simiar to princomp


## run a vegan PCA with rda()

```{r}
library(vegan)
my.rda <- rda(iris[,-5])


#"[,-5]" drops that last columns
##the species code
```




## Plot the RDA

Note to get help when doing and RDA biplot, call ?biplot.rda; however, use biplot() for the actual plotting.

### Default biplot of RDA output

```{r}
biplot(my.rda)
```

Note that vegan's scaling is different than a normal biplot.



### biplot.rda options

* vegan is package for ecological analysis and so its functions are oriented towards particular kinds of analyses
* the "display" arguement is not in the normal biplot comman used with princomp
    + "display = 'sites' " corresonds to the rows of data; one datapoint per row
    + "display = 'species'" corresponds to the columns of data; one line/arrow per column
* "type" is an argument also not in biplots originating from princomp
    + "type = 'text' " plots row numbers and column names as labels
    + "type = points' " plots points

```{r}
biplot(my.rda,
       display = c("sites", 
                   "species"),
       type = c("text",
                "points"))
```



# vegan's ordination plotting functions

* vegan has lots of helpful functions for plotting ordinations.
    + ordihull: convex polygons around groups of points
    + ordiellipse: ellipses around centroids (SD or SE)

## Add "hulls" around each species
```{r}
#make basic plot
biplot(my.rda,
       display = c("sites", 
                   "species"),
       type = c("text",
                "points"))

#Add "hulls"
ordihull(my.rda,
         group = iris$Species)
```



## Make plot pretty

```{r}
#make basic plot
biplot(my.rda,
       display = c("sites", 
                   "species"),
       type = c("text",
                "points"))

#get names of species
## levels() extracts fator levels
## from the column
spp.names <- levels(iris$Species)

#Add hulls
ordihull(my.rda,
         group = iris$Species,
         col = c(1,2,3))


#Add legend
legend("topright",
       col = c(1,2,3), 
       lty = 1,
       legend = spp.names)
```



### with ggplot2

```{r}
library(vegan)

data("iris")

head(iris)

biplot(princomp(iris[,-5]))
```



```{r}
iris.nmds <- metaMDS(iris[,-5],k = 3,
                          distance = "bray")

ordiplot(iris.nmds)

```








```{r}
data.scores <- as.data.frame(scores(iris.nmds))  #Using the scores function from vegan to extract the site scores and convert to a data.frame
data.scores$site <- rownames(data.scores)  # create a column of site names, from the rownames of data.scores
data.scores$grp <- iris$Species  #  add the grp variable created earlier
head(data.scores)  #look at the data
```


```{r}
species.scores <- as.data.frame(scores(iris.nmds, "species"))  #Using the scores function from vegan to extract the species scores and convert to a data.frame
species.scores$species <- rownames(species.scores)  # create a column of species, from the rownames of species.scores
head(species.scores)  #look at the data
```


```{r}
ggplot() + 
  geom_text(data=species.scores,
            aes(x=NMDS1,y=NMDS2,
                label=species),alpha=0.5) +  # add the species labels
  geom_point(data=data.scores,
             aes(x=NMDS1,y=NMDS2,shape=grp,colour=grp),size=1) + # add the point markers
  #geom_text(data=data.scores,aes(x=NMDS1,y=NMDS2,label=site),size=6,vjust=0) +  # add the site labels
  #scale_colour_manual(values=c("A" = "red", "B" = "blue")) +
  coord_equal() +
  theme_bw()
```




